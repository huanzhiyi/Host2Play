name: Host2Play Auto Renew (Turnstile Enhanced)

on:
  # å®šæ—¶è¿è¡Œï¼šæ¯å¤© UTC 00:00 (åŒ—äº¬æ—¶é—´ 08:00)
  schedule:
    - cron: '0 0 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      debug:
        description: 'å¯ç”¨è°ƒè¯•æ¨¡å¼'
        required: false
        type: boolean
        default: false

jobs:
  renew-with-turnstile:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            xvfb \
            wget \
            gnupg \
            chromium-browser \
            chromium-chromedriver
          
          # éªŒè¯ Chrome å®‰è£…
          chromium-browser --version || google-chrome --version || echo "Chrome not found"
      
      - name: ğŸ“š Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements_turnstile.txt
          
          # æ˜¾ç¤ºå…³é”®ä¾èµ–ç‰ˆæœ¬
          echo "=== Key Dependencies ==="
          pip list | grep -E "(selenium|turnstile|opencv|ultralytics|undetected)" || true
      
      - name: ğŸ” Verify turnstile-solver installation
        run: |
          python -c "from turnstile_solver import solve, Solver; print('âœ… turnstile-solver installed successfully')"
      
      - name: ğŸ“¥ Download YOLO model (if needed)
        run: |
          if [ ! -f "model.onnx" ]; then
            echo "Downloading YOLO model..."
            python download_yolo_model.py || echo "Model download script not found, will download during execution"
          else
            echo "YOLO model already exists"
            ls -lh model.onnx
          fi
      
      - name: ğŸ›¡ï¸ Run renewal with Turnstile bypass
        id: renew
        run: |
          echo "Starting Host2Play renewal with Turnstile support..."
          xvfb-run -a --server-args="-screen 0 1920x1080x24" \
            python host2play_auto_renew_ci_selenium_fixed.py
        env:
          RENEW_URL: ${{ secrets.RENEW_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          HEADLESS: "false"  # ä½¿ç”¨ xvfb-runï¼Œä¸éœ€è¦å®Œå…¨ headless
          CI: "true"
          YOLO_MODEL_PATH: "model.onnx"
          YOLO_MODEL_URL_1: ${{ secrets.YOLO_MODEL_URL_1 || 'https://media.githubusercontent.com/media/DannyLuna17/RecaptchaV2-IA-Solver/main/model.onnx' }}
          YOLO_MODEL_URL_2: ${{ secrets.YOLO_MODEL_URL_2 || 'https://github.com/DannyLuna17/RecaptchaV2-IA-Solver/raw/main/model.onnx' }}
      
      - name: ğŸ“Š Display run summary
        if: always()
        run: |
          echo "### ğŸ¯ Renewal Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "host2play_renew_success.png" ]; then
            echo "âœ… **Status**: SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“… **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status**: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“… **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¸ Screenshots" >> $GITHUB_STEP_SUMMARY
          ls -1 *.png 2>/dev/null | head -10 | while read file; do
            echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
          done || echo "No screenshots found" >> $GITHUB_STEP_SUMMARY
      
      - name: ğŸ‰ Upload success screenshot
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: success-screenshot-${{ github.run_number }}
          path: host2play_renew_success.png
          retention-days: 7
          if-no-files-found: warn
      
      - name: ğŸ“¸ Upload debug screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-screenshots-${{ github.run_number }}
          path: |
            turnstile_*.png
            cf_bypass_*.png
            host2play_cloudflare_*.png
            *.png
          retention-days: 7
          if-no-files-found: ignore
      
      - name: âŒ Upload error screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-screenshots-${{ github.run_number }}
          path: |
            host2play_error*.png
            turnstile_failed.png
            turnstile_error.png
            host2play_cloudflare_wait.png
            host2play_error_cloudflare.png
            host2play_error_recaptcha_*.png
            host2play_error_no_renew_button.png
            0.png
            1.png
            2.png
            3.png
            4.png
            5.png
            6.png
            7.png
            8.png
            9.png
          retention-days: 14
          if-no-files-found: ignore
      
      - name: ğŸ§¹ Cleanup old workflow runs
        if: always()
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          delete_workflow_pattern: ${{ github.workflow }}
          retain_days: 0
          keep_minimum_runs: 5
      
      - name: ğŸ“ Create issue on failure
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ Host2Play ç»­æœŸå¤±è´¥ - ${new Date().toISOString().split('T')[0]}`,
              body: `è‡ªåŠ¨ç»­æœŸä»»åŠ¡å¤±è´¥\n\n**Run ID**: ${context.runId}\n**Workflow**: ${context.workflow}\n**Time**: ${new Date().toUTCString()}\n\nè¯·æ£€æŸ¥ [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId}) çš„æ—¥å¿—å’Œæˆªå›¾ã€‚`,
              labels: ['automation', 'renewal-failed']
            });
            console.log(`Created issue #${issue.data.number}`);
